<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <meta name="referrer" content="no-referrer">
  <title>ÿØÿ±ÿØÿ¥ÿ™Ÿä</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Tajawal', Arial, sans-serif;
      background: #0d0d1a;
      height: 100vh;
      display: flex;
      flex-direction: column;
      color: #fff;
      overscroll-behavior: none;
    }
    .header {
      background: rgba(7, 94, 84, 0.95);
      color: white;
      padding: 10px 12px;
      text-align: center;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .tabs {
      display: flex;
      background: #075e54;
      padding: 0;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }
    .tab {
      flex: 1;
      padding: 12px 0;
      text-align: center;
      cursor: pointer;
      color: rgba(255,255,255,0.8);
      transition: color 0.2s;
      font-weight: 500;
      font-size: 14px;
    }
    .tab:hover { color: white; }
    .tab.active {
      color: white;
      font-weight: 700;
      border-bottom: 2px solid #25D366;
    }
    .chat {
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .msg {
      max-width: 75%;
      padding: 10px;
      border-radius: 16px;
      word-wrap: break-word;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: background-color 0.5s ease;
    }
    .in { background: var(--msg-in-bg, #2c2c3e); align-self: flex-start; border-bottom-left-radius: 6px; }
    .out { background: var(--msg-out-bg, #1e3a5f); align-self: flex-end; border-bottom-right-radius: 6px; }
    
    .msg-content {
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }
    .avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid #25D366;
      margin-top: 2px;
    }
    .msg-text {
      flex: 1;
      direction: rtl;
      font-size: 14px;
    }
    .msg-text b {
      display: block;
      font-weight: 600;
      margin-bottom: 3px;
      color: #fff;
      font-size: 13px;
    }
    .msg-text img, .msg-text audio {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 5px;
      display: block;
    }

    .input-area {
      display: flex;
      padding: 8px;
      background: rgba(255,255,255,0.08);
      gap: 6px;
      border-top: 1px solid rgba(255,255,255,0.1);
      align-items: center;
      flex-wrap: wrap;
    }
    .input-area input {
      flex: 1;
      padding: 8px 12px;
      border: none;
      background: rgba(0,0,0,0.3);
      border-radius: 20px;
      font-size: 13px;
      outline: none;
      min-width: 120px;
      color: white;
    }
    .input-area button {
      border: none;
      background: #075e54;
      color: white;
      padding: 0 12px;
      border-radius: 18px;
      font-weight: 500;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .attach-btn, .emoji-btn, .voice-btn {
      background: #5c677d;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 16px;
      cursor: pointer;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      transition: background 0.2s;
    }
    .voice-btn.recording {
      background: #d32f2f;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.5); }
      70% { box-shadow: 0 0 0 10px rgba(211, 47, 47, 0); }
      100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); }
    }

    .status-preview {
      max-width: 80%;
      margin: 10px auto;
      padding: 12px;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      text-align: center;
      backdrop-filter: blur(5px);
      font-size: 14px;
    }
    #statusText {
      width: 90%;
      margin: 10px auto;
      padding: 10px;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background: rgba(0,0,0,0.3);
      color: white;
      font-family: 'Tajawal', sans-serif;
      font-size: 14px;
    }
    #progressContainer {
      height: 5px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      margin: 6px 0;
      overflow: hidden;
      display: none;
    }
    #progressBar {
      height: 100%;
      background: #25D366;
      width: 0%;
      transition: width 0.2s;
    }
    #emojiPanel {
      display: none;
      position: absolute;
      bottom: 80px;
      right: 15px;
      background: rgba(30, 30, 46, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
      z-index: 100;
      max-width: 300px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .emoji-item {
      font-size: 20px;
      cursor: pointer;
      padding: 5px;
      border-radius: 6px;
      transition: transform 0.2s;
    }
    .emoji-item:hover {
      transform: scale(1.2);
      background: rgba(255,255,255,0.1);
    }
    .online-indicator {
      font-size: 12px;
      color: #fff;
      background: #25D366;
      padding: 3px 10px;
      border-radius: 18px;
      margin-left: 8px;
    }
    .online-list {
      font-size: 11px;
      color: #e0e0ff;
      background: rgba(255,255,255,0.08);
      padding: 6px 10px;
      border-radius: 8px;
      margin: 8px 12px 0;
      display: none;
      backdrop-filter: blur(5px);
    }
    .delivery-status {
      font-size: 11px;
      color: #aaa;
      margin-top: 3px;
      direction: ltr;
    }

    #inAppNotification {
      position: fixed;
      bottom: 15px;
      left: 15px;
      background: rgba(7, 94, 84, 0.95);
      color: white;
      padding: 12px 16px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
      z-index: 1000;
      max-width: 260px;
      display: none;
      font-family: 'Tajawal', sans-serif;
      direction: rtl;
      animation: slideIn 0.3s ease-out;
      font-size: 13px;
    }
    @keyframes slideIn {
      from { transform: translateY(100px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .user-avatar-header {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      overflow: hidden;
      cursor: pointer;
    }
    .user-avatar-header img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
  </style>
</head>
<body>
  <div class="header">
    <div style="display:flex;align-items:center;gap:10px;">
      <div class="user-avatar-header" onclick="changeAvatar()">
        <img id="userAvatar" src="" alt="ÿ£ŸÜÿß" />
      </div>
      <span>ÿØÿ±ÿØÿ¥ÿ™Ÿä</span>
    </div>
    <div class="online-indicator" id="onlineCount">ŸÖÿ™ÿµŸÑŸäŸÜ: 0</div>
  </div>
  
  <div class="tabs">
    <div class="tab active" data-room="family">ÿπÿßÿ¶ŸÑÿ©</div>
    <div class="tab" data-room="public">ÿπÿßŸÖÿ©</div>
    <div class="tab" data-room="status">ÿ≠ÿßŸÑÿßÿ™</div>
  </div>

  <div id="family-chat" class="chat"></div>
  <div id="public-chat" class="chat" style="display:none;"></div>
  <div id="status-section" class="chat" style="display:none;">
    <input type="text" id="statusText" placeholder="ÿßŸÉÿ™ÿ® ÿ≠ÿßŸÑÿ™ŸÉ..." />
    <button onclick="postStatus()" style="margin:8px auto; display:block; padding:6px 16px; background:#075e54; color:white; border:none; border-radius:6px; font-size:13px;">ŸÜÿ¥ÿ± ÿßŸÑÿ≠ÿßŸÑÿ©</button>
    <div id="statusFeed"></div>
  </div>

  <div class="online-list" id="onlineList"></div>

  <div class="input-area" id="main-input">
    <input type="text" id="msg" placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ©..." onkeypress="if(event.key==='Enter') sendText()" />
    <input type="file" id="imageUpload" accept="image/*" style="display:none;" />
    <button class="attach-btn" onclick="document.getElementById('imageUpload').click()">üìé</button>
    <button class="emoji-btn" onclick="toggleEmojiPanel()">üòä</button>
    <button class="voice-btn" onclick="recordAudio()">üé§</button>
    <button onclick="sendText()">ÿ•ÿ±ÿ≥ÿßŸÑ</button>
  </div>

  <div id="progressContainer">
    <div id="progressBar"></div>
  </div>

  <div id="emojiPanel"></div>

  <div id="inAppNotification">
    <b id="notifName"></b><br>
    <span id="notifText"></span>
  </div>

  <script>
    const emojiList = ['üòä', 'üòÇ', 'üòç', 'ü•∞', 'üòé', 'ü§©', 'ü•≥', 'üò≠', 'üò°', 'üëç', 'üëè', 'üíñ', 'üíØ', 'üî•', '‚ú®', 'üéâ', '‚ù§Ô∏è', 'ü´†', 'ü´∂', 'üôè'];
  </script>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let currentRoom = 'family';
    let myName = localStorage.name || prompt('ŸÖÿß ÿßÿ≥ŸÖŸÉÿü') || 'ÿ≤ÿßÿ¶ÿ±';
    localStorage.name = myName;

    // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ¥ÿÆÿµŸäÿ©
    let myAvatar = localStorage.getItem('userAvatar') || null;
    if (!myAvatar) {
      myAvatar = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMCIgaGVpZ2h0PSIzMCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSIxMiIgY3k9IjgiIHI9IjUiIGZpbGw9IiM5NTk1OTUiLz48cGF0aCBkPSJNMjAgMjJINGEwIDEgMCAwIDEtMS0xdi0yYTUgNSAwIDAgMTE1LTVoOGE1IDUgMCAwIDE1IDV2MmExIDEgMCAwIDEtMSAxeiIgZmlsbD0iIzk1OTU5NSIvPjwvc3ZnPg==';
      localStorage.setItem('userAvatar', myAvatar);
    }
    document.getElementById('userAvatar').src = myAvatar;

    // ŸÜÿ∏ÿßŸÖ ÿßŸÑÿµŸàÿ™
    let audioContext = null;
    let soundsEnabled = false;

    function initAudio() {
      if (soundsEnabled) return;
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        soundsEnabled = true;
      } catch (e) {}
    }

    function playTone(freq, duration = 100, volume = 0.1) {
      if (!soundsEnabled) return;
      try {
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc.connect(gain);
        gain.connect(audioContext.destination);
        osc.type = 'sine';
        osc.frequency.value = freq;
        gain.gain.value = volume;
        osc.start();
        setTimeout(() => { osc.stop(); }, duration);
      } catch (e) {}
    }

    function playSendSound() { playTone(800, 100); }
    function playReceiveSound() { playTone(600, 150); }

    document.body.addEventListener('click', initAudio, { once: true });
    document.body.addEventListener('touchstart', initAudio, { once: true });

    // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿ∫ÿ±ŸÅÿ©
    function ensureCurrentRoom() {
      if (!currentRoom) {
        currentRoom = 'family';
        const tab = document.querySelector('.tab[data-room="family"]');
        if (tab) {
          tab.click();
        }
      }
    }

    // ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿØÿßÿÆŸÑŸäÿ©
    const unreadCounts = { family: 0, public: 0 };

    function showInAppNotification(name, text, room) {
      if (currentRoom !== room) {
        unreadCounts[room]++;

        const tab = document.querySelector(`.tab[data-room="${room}"]`);
        const baseName = room === 'family' ? 'ÿπÿßÿ¶ŸÑÿ©' : 'ÿπÿßŸÖÿ©';
        tab.textContent = `${baseName} (${unreadCounts[room]})`;

        const notif = document.getElementById('inAppNotification');
        document.getElementById('notifName').textContent = name;
        document.getElementById('notifText').textContent = text || 'ÿ£ÿ±ÿ≥ŸÑ ŸÖÿ≠ÿ™ŸàŸâ';
        notif.style.display = 'block';

        setTimeout(() => {
          notif.style.display = 'none';
        }, 4000);
      }
    }

    // ÿπÿ±ÿ∂ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©
    function appendMessage(name, text, isSelf, image = null, audio = null, senderAvatar = null) {
      const chat = document.getElementById(currentRoom === 'family' ? 'family-chat' : 'public-chat');
      const div = document.createElement('div');
      div.className = isSelf ? 'msg out' : 'msg in';

      const avatarSrc = senderAvatar || 
        'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyOCIgaGVpZ2h0PSIyOCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSIxMiIgY3k9IjgiIHI9IjUiIGZpbGw9IiM5NTk1OTUiLz48cGF0aCBkPSJNMjAgMjJINGEwIDEgMCAwIDEtMS0xdi0yYTUgNSAwIDAgMTE1LTVoOGE1IDUgMCAwIDE1IDV2MmExIDEgMCAwIDEtMSAxeiIgZmlsbD0iIzk1OTU5NSIvPjwvc3ZnPg==';

      let mediaHtml = '';
      if (image) {
        mediaHtml = `<img src="${image}" />`;
      } else if (audio) {
        mediaHtml = `<audio controls src="${audio}"></audio>`;
      }

      const statusText = isSelf ? '‚úì‚úì' : '';

      div.innerHTML = `
        <div class="msg-content">
          <img src="${avatarSrc}" class="avatar" />
          <div class="msg-text">
            <b>${name}:</b>
            ${text || ''}
            ${mediaHtml}
            ${statusText ? `<div class="delivery-status">${statusText}</div>` : ''}
          </div>
        </div>
      `;

      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;

      if (!isSelf) {
        playReceiveSound();
      }
    }

    function loadMessages(room, msgs) {
      const chat = document.getElementById(room === 'family' ? 'family-chat' : 'public-chat');
      chat.innerHTML = '';
      msgs.forEach(msg => {
        if (msg.type === 'text') {
          appendMessage(msg.name, msg.text, msg.name === myName, null, null, msg.avatar);
        } else if (msg.type === 'image') {
          appendMessage(msg.name, '', msg.name === myName, msg.image, null, msg.avatar);
        } else if (msg.type === 'audio') {
          appendMessage(msg.name, '', msg.name === myName, null, msg.audio, msg.avatar);
        }
      });
    }

    function loadStatuses(statuses) {
      const feed = document.getElementById('statusFeed');
      feed.innerHTML = '';
      statuses.forEach(st => {
        const div = document.createElement('div');
        div.className = 'status-preview';
        div.innerHTML = `<b>${st.name}</b><br>${st.text}`;
        feed.prepend(div);
      });
    }

    function joinRoom(room) {
      socket.emit('joinRoom', { room, name: myName, avatar: myAvatar });
    }

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentRoom = tab.dataset.room;

        document.getElementById('family-chat').style.display = currentRoom === 'family' ? 'flex' : 'none';
        document.getElementById('public-chat').style.display = currentRoom === 'public' ? 'flex' : 'none';
        document.getElementById('status-section').style.display = currentRoom === 'status' ? 'block' : 'none';
        document.getElementById('main-input').style.display = currentRoom === 'status' ? 'none' : 'flex';
        document.getElementById('onlineList').style.display = currentRoom === 'status' ? 'none' : 'block';

        if (currentRoom !== 'status') {
          unreadCounts[currentRoom] = 0;
          const baseName = currentRoom === 'family' ? 'ÿπÿßÿ¶ŸÑÿ©' : 'ÿπÿßŸÖÿ©';
          tab.textContent = baseName;
          joinRoom(currentRoom);
        } else {
          socket.emit('loadStatuses', []);
        }
      });
    });

    socket.on('loadMessages', (data) => {
      if (data.room === currentRoom) loadMessages(data.room, data.messages);
    });

    socket.on('loadStatuses', (statuses) => loadStatuses(statuses));

    socket.on('onlineUsers', (data) => {
      if (data.room === currentRoom) {
        document.getElementById('onlineCount').textContent = `ŸÖÿ™ÿµŸÑŸäŸÜ: ${data.count}`;
        const listEl = document.getElementById('onlineList');
        listEl.innerHTML = `<b>ÿßŸÑŸÖÿ™ÿµŸÑŸàŸÜ:</b> ${data.users.join(', ')}`;
        listEl.style.display = 'block';
      }
    });

    socket.on('userAvatarUpdate', (data) => {
      localStorage.setItem(`avatar_${data.name}`, data.avatar);
      // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿ≠ÿßŸÑŸäÿ©
      document.querySelectorAll('.msg-text b').forEach(el => {
        if (el.textContent.trim() === data.name + ':') {
          const avatarImg = el.closest('.msg-content').querySelector('.avatar');
          if (avatarImg) avatarImg.src = data.avatar;
        }
      });
    });

    function sendText() {
      ensureCurrentRoom();
      const text = document.getElementById('msg').value.trim();
      if (!text) return;
      socket.emit('sendMessage', { room: currentRoom, name: myName, text });
      playSendSound();
      document.getElementById('msg').value = '';
    }

    document.getElementById('imageUpload').addEventListener('change', (e) => {
      ensureCurrentRoom();
      const file = e.target.files[0];
      if (!file || !file.type.match('image/')) return;

      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';

      const reader = new FileReader();
      reader.onprogress = (ev) => {
        if (ev.lengthComputable) {
          const percent = Math.round((ev.loaded / ev.total) * 100);
          progressBar.style.width = percent + '%';
        }
      };

      reader.onload = (ev) => {
        socket.emit('sendImage', { room: currentRoom, name: myName, image: ev.target.result });
        playSendSound();
        e.target.value = '';
        progressContainer.style.display = 'none';
      };

      reader.readAsDataURL(file);
    });

    async function recordAudio() {
      ensureCurrentRoom();
      const voiceBtn = document.querySelector('.voice-btn');
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        voiceBtn.classList.add('recording');
        voiceBtn.innerHTML = 'üéôÔ∏è';

        const mediaRecorder = new MediaRecorder(stream);
        const chunks = [];

        mediaRecorder.ondataavailable = (e) => {
          chunks.push(e.data);
        };

        mediaRecorder.onstop = async () => {
          voiceBtn.classList.remove('recording');
          voiceBtn.innerHTML = 'üé§';
          stream.getTracks().forEach(track => track.stop());

          const blob = new Blob(chunks, { type: 'audio/ogg; codecs=opus' });
          const reader = new FileReader();
          reader.onload = () => {
            socket.emit('sendAudio', { room: currentRoom, name: myName, audio: reader.result });
            playSendSound();
          };
          reader.readAsDataURL(blob);
        };

        mediaRecorder.start();
        setTimeout(() => { mediaRecorder.stop(); }, 8000);

      } catch (err) {
        voiceBtn.classList.remove('recording');
        voiceBtn.innerHTML = 'üé§';
        alert('ŸÑŸÖ Ÿäÿ™ŸÖŸÉŸÜ ŸÖŸÜ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÖŸäŸÉÿ±ŸàŸÅŸàŸÜ: ' + (err.message || 'ÿßŸÑÿ•ÿ∞ŸÜ ŸÖÿ±ŸÅŸàÿ∂'));
      }
    }

    function postStatus() {
      const text = document.getElementById('statusText').value.trim();
      if (!text) return;
      socket.emit('postStatus', { name: myName, text });
      document.getElementById('statusText').value = '';
    }

    socket.on('receiveMessage', (data) => {
      const isSelf = data.name === myName;
      if (data.room === currentRoom) {
        appendMessage(data.name, data.text, isSelf, null, null, data.avatar);
      } else {
        showInAppNotification(data.name, data.text, data.room);
      }
    });

    socket.on('receiveImage', (data) => {
      const isSelf = data.name === myName;
      if (data.room === currentRoom) {
        appendMessage(data.name, '', isSelf, data.image, null, data.avatar);
      } else {
        showInAppNotification(data.name, 'ÿ£ÿ±ÿ≥ŸÑ ÿµŸàÿ±ÿ©', data.room);
      }
    });

    socket.on('receiveAudio', (data) => {
      const isSelf = data.name === myName;
      if (data.room === currentRoom) {
        appendMessage(data.name, '', isSelf, null, data.audio, data.avatar);
      } else {
        showInAppNotification(data.name, 'ÿ£ÿ±ÿ≥ŸÑ ÿ±ÿ≥ÿßŸÑÿ© ÿµŸàÿ™Ÿäÿ©', data.room);
      }
    });

    socket.on('newStatus', (data) => {
      const feed = document.getElementById('statusFeed');
      const div = document.createElement('div');
      div.className = 'status-preview';
      div.innerHTML = `<b>${data.name}</b><br>${data.text}`;
      feed.prepend(div);
    });

    // ÿ™ÿ∫ŸäŸäÿ± ŸÑŸàŸÜ ÿßŸÑŸÅŸÇÿßÿπÿßÿ™ ŸÉŸÑ 15 ÿ´ÿßŸÜŸäÿ©
    const bubbleColors = [
      { in: '#2c2c3e', out: '#1e3a5f' },
      { in: '#2d3748', out: '#2b6cb0' },
      { in: '#2f2f47', out: '#4c51bf' },
      { in: '#2c3a47', out: '#38ada9' },
      { in: '#2f3542', out: '#ff6b81' },
      { in: '#2c2e3e', out: '#55efc4' },
      { in: '#2d3436', out: '#fdcb6e' },
      { in: '#2f3640', out: '#a29bfe' }
    ];

    let colorIndex = 0;
    setInterval(() => {
      const colors = bubbleColors[colorIndex % bubbleColors.length];
      colorIndex++;
      document.documentElement.style.setProperty('--msg-in-bg', colors.in);
      document.documentElement.style.setProperty('--msg-out-bg', colors.out);
      
      document.querySelectorAll('.msg.in').forEach(el => el.style.backgroundColor = colors.in);
      document.querySelectorAll('.msg.out').forEach(el => el.style.backgroundColor = colors.out);
    }, 15000);

    // ŸÑŸàÿ≠ÿ© ÿßŸÑÿ•ŸäŸÖŸàÿ¨Ÿä
    function toggleEmojiPanel() {
      const panel = document.getElementById('emojiPanel');
      if (panel.style.display === 'flex') {
        panel.style.display = 'none';
      } else {
        panel.innerHTML = '';
        emojiList.forEach(emoji => {
          const span = document.createElement('span');
          span.className = 'emoji-item';
          span.textContent = emoji;
          span.onclick = () => {
            document.getElementById('msg').value += emoji;
            document.getElementById('msg').focus();
            panel.style.display = 'none';
          };
          panel.appendChild(span);
        });
        panel.style.display = 'flex';
      }
    }

    document.addEventListener('click', (e) => {
      const panel = document.getElementById('emojiPanel');
      const btn = document.querySelector('.emoji-btn');
      if (!panel.contains(e.target) && e.target !== btn) {
        panel.style.display = 'none';
      }
    });

    // ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ¥ÿÆÿµŸäÿ©
    function changeAvatar() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          myAvatar = ev.target.result;
          localStorage.setItem('userAvatar', myAvatar);
          document.getElementById('userAvatar').src = myAvatar;
          socket.emit('updateAvatar', { avatar: myAvatar });
        };
        reader.readAsDataURL(file);
      };
      input.click();
    }

    joinRoom(currentRoom);
  </script>
</body>
        </html>
