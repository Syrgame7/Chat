<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>ÿØÿ±ÿØÿ¥ÿ™Ÿä</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #e5ddd5;
      height: 100vh;
      display: flex;
      flex-direction: column;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .header {
      background: #075e54;
      color: white;
      padding: 12px 16px;
      text-align: center;
      font-weight: bold;
      font-size: 18px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .setup {
      padding: 12px;
      background: white;
      text-align: center;
      border-bottom: 1px solid #ddd;
    }
    .setup input {
      padding: 8px;
      font-size: 16px;
      width: 90%;
      max-width: 200px;
      border: 1px solid #ccc;
      border-radius: 6px;
      outline: none;
    }
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      background: #e5ddd5;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .message {
      max-width: 70%;
      padding: 8px 12px;
      margin: 4px 0;
      border-radius: 8px;
      word-wrap: break-word;
      line-height: 1.4;
      position: relative;
      font-size: 16px;
    }
    .received {
      background: #fff;
      align-self: flex-start;
      border-bottom-left-radius: 3px;
    }
    .sent {
      background: #dcf8c6;
      align-self: flex-end;
      border-bottom-right-radius: 3px;
    }
    .message-info {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
      text-align: right;
    }
    .input-area {
      display: flex;
      padding: 8px;
      background: #fff;
      border-top: 1px solid #ccc;
      gap: 8px;
    }
    .input-area textarea {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      border: none;
      background: #f0f0f0;
      border-radius: 20px;
      outline: none;
      min-height: 40px;
      max-height: 120px;
      overflow-y: auto;
      resize: none;
    }
    .input-area button {
      border: none;
      background: #075e54;
      color: white;
      padding: 0 16px;
      border-radius: 20px;
      font-weight: bold;
      cursor: pointer;
      min-height: 40px;
    }
    .voice-btn {
      background: #6c757d;
      padding: 0 12px;
      border-radius: 20px;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .voice-btn.recording {
      background: #dc3545;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      '0%' { transform: scale(1); }
      '50%' { transform: scale(1.1); }
      '100%' { transform: scale(1); }
    }
    @media (max-width: 480px) {
      .message {
        max-width: 85%;
        font-size: 14px;
      }
      .input-area textarea {
        font-size: 14px;
      }
      .header {
        font-size: 16px;
        padding: 10px 12px;
      }
    }
  </style>
</head>
<body>
  <div class="header">ÿØÿ±ÿØÿ¥ÿ™Ÿä üåê</div>
  <div class="setup"><input type="text" id="user" placeholder="ÿßÿ≥ŸÖŸÉ" value="ÿ≤ÿßÿ¶ÿ±"></div>
  <div class="chat-container" id="msgs"></div>
  <div class="input-area">
    <textarea id="txt" placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ™ŸÉ..." autocomplete="off" rows="1"></textarea>
    <button id="sendBtn">ÿ•ÿ±ÿ≥ÿßŸÑ</button>
    <button class="voice-btn" id="voiceBtn">üé§ ÿ™ÿ≥ÿ¨ŸäŸÑ</button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const msgs = document.getElementById('msgs');
    const txt = document.getElementById('txt');
    const user = document.getElementById('user');
    const sendBtn = document.getElementById('sendBtn');
    const voiceBtn = document.getElementById('voiceBtn');

    socket.on('prev', function(m) {
      m.forEach(function(msg) {
        addMessage(msg, msg.id === socket.id ? 'sent' : 'received');
      });
    });
    socket.on('msg', function(msg) {
      addMessage(msg, msg.id === socket.id ? 'sent' : 'received');
    });

    txt.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });

    let isRecording = false;
    let mediaRecorder;
    let audioChunks = [];

    voiceBtn.addEventListener('click', function() {
      if (!isRecording) {
        navigator.mediaDevices.getUserMedia({ audio: true })
          .then(function(stream) {
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.ondataavailable = function(e) { audioChunks.push(e.data); };
            mediaRecorder.start();
            isRecording = true;
            voiceBtn.classList.add('recording');
            voiceBtn.textContent = 'üõë ÿ•ŸäŸÇÿßŸÅ';
          })
          .catch(function(err) {
            alert('ŸÑŸÖ Ÿäÿ™ŸÖŸÉŸÜ ŸÖŸÜ ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÑŸÖŸäŸÉÿ±ŸàŸÅŸàŸÜ: ' + err.message);
          });
      } else {
        mediaRecorder.stop();
        isRecording = false;
        voiceBtn.classList.remove('recording');
        voiceBtn.textContent = 'üé§ ÿ™ÿ≥ÿ¨ŸäŸÑ';

        mediaRecorder.onstop = function() {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });

          // ÿ™ÿ≠ŸàŸäŸÑ Blob ÿ•ŸÑŸâ ArrayBuffer
          const reader = new FileReader();
          reader.onload = function() {
            const uint8Array = new Uint8Array(reader.result);

            fetch('/upload-audio', {
              method: 'POST',
              headers: { 'Content-Type': 'application/octet-stream' },
              body: uint8Array
            })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                socket.emit('send', { u: user.value || 'ÿ≤ÿßÿ¶ÿ±', t: data.url, isAudio: true });
              } else {
                alert('‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿ±ŸÅÿπ ÿßŸÑÿµŸàÿ™: ' + (data.error || 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ'));
              }
            })
            .catch(err => {
              alert('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿÆÿßÿØŸÖ: ' + err.message);
            });
          };
          reader.readAsArrayBuffer(audioBlob);
        };
      }
    });

    sendBtn.addEventListener('click', send);
    txt.addEventListener('keypress', function(e) { if (e.key === 'Enter') send(); });

    function send() {
      const text = txt.value.trim();
      if (text) {
        socket.emit('send', { u: user.value || 'ÿ≤ÿßÿ¶ÿ±', t: text });
        txt.value = '';
        txt.style.height = 'auto';
        txt.focus();
      }
    }

    function addMessage(msg, type) {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message ' + type;
      const time = msg.time || new Date().toLocaleTimeString('ar-EG');
      let content = '<strong>' + (msg.u || 'ÿ≤ÿßÿ¶ÿ±') + ':</strong> ';

      if (msg.isAudio) {
        content += '<br><audio controls src="' + msg.t + '" style="width: 100%; margin-top: 5px;"></audio>';
      } else {
        content += msg.t;
      }

      msgDiv.innerHTML = content + '<br><small class="message-info">' + time + '</small>';
      msgs.appendChild(msgDiv);
      msgs.scrollTop = msgs.scrollHeight;
    }
  </script>
</body>
  </html>
