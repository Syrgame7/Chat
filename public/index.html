<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="referrer" content="no-referrer">
  <title>Ø¯Ø±Ø¯Ø´ØªÙŠ Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Tajawal', Arial, sans-serif;
      background: #e5ddd5;
      height: 100vh;
      display: flex;
      flex-direction: column;
      color: #333;
    }
    .header {
      background: #075e54;
      color: white;
      padding: 14px 16px;
      text-align: center;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .tabs {
      display: flex;
      background: #075e54;
      padding: 0;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    .tab {
      flex: 1;
      padding: 14px 0;
      text-align: center;
      cursor: pointer;
      color: rgba(255,255,255,0.7);
      transition: color 0.2s;
      font-weight: 500;
    }
    .tab:hover { color: white; }
    .tab.active {
      color: white;
      font-weight: 700;
      border-bottom: 2px solid #25D366;
    }
    .chat {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .msg {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 16px;
      word-wrap: break-word;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: color 0.3s;
    }
    .in { background: #fff; align-self: flex-start; border-bottom-left-radius: 4px; }
    .out { background: #dcf8c6; align-self: flex-end; border-bottom-right-radius: 4px; }
    
    .msg img {
      max-width: 100%;
      border-radius: 10px;
      margin-top: 8px;
      display: block;
    }

    .input-area {
      display: flex;
      padding: 12px;
      background: #fff;
      gap: 10px;
      border-top: 1px solid #ddd;
      align-items: center;
      flex-wrap: wrap;
    }
    .input-area input {
      flex: 1;
      padding: 12px 18px;
      border: none;
      background: #f0f0f0;
      border-radius: 24px;
      font-size: 15px;
      outline: none;
      min-width: 200px;
    }
    .input-area button {
      border: none;
      background: #075e54;
      color: white;
      padding: 0 18px;
      border-radius: 20px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    .input-area button:hover {
      background: #064a43;
    }
    .attach-btn, .emoji-btn {
      background: #6c757d;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      transition: background 0.2s;
    }
    .attach-btn:hover, .emoji-btn:hover {
      background: #5a6268;
    }

    .status-preview {
      max-width: 80%;
      margin: 12px auto;
      padding: 14px;
      background: white;
      border-radius: 14px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    #statusText {
      width: 90%;
      margin: 12px auto;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-family: 'Tajawal', sans-serif;
      font-size: 15px;
    }

    #progressContainer {
      height: 6px;
      background: #f0f0f0;
      border-radius: 3px;
      margin: 8px 0;
      overflow: hidden;
      display: none;
    }
    #progressBar {
      height: 100%;
      background: #075e54;
      width: 0%;
      transition: width 0.2s;
    }

    #emojiPanel {
      display: none;
      position: absolute;
      bottom: 80px;
      right: 20px;
      background: white;
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 100;
      max-width: 300px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .emoji-item {
      font-size: 20px;
      cursor: pointer;
      padding: 4px;
      border-radius: 6px;
    }
    .emoji-item:hover {
      background: #f0f0f0;
    }

    .online-indicator {
      font-size: 13px;
      color: #fff;
      background: #25D366;
      padding: 4px 10px;
      border-radius: 20px;
      margin-left: 10px;
    }

    .online-list {
      font-size: 12px;
      color: #333;
      background: #fff8dc;
      padding: 6px 10px;
      border-radius: 10px;
      margin: 8px 16px 0;
      display: none;
    }

    .delivery-status {
      font-size: 12px;
      color: #999;
      margin-top: 4px;
      direction: ltr;
    }
  </style>
</head>
<body>
  <div class="header">
    <span>Ø¯Ø±Ø¯Ø´ØªÙŠ Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© ğŸŒ</span>
    <div class="online-indicator" id="onlineCount">Ù…ØªØµÙ„ÙŠÙ†: 0</div>
  </div>
  
  <div class="tabs">
    <div class="tab active" data-room="family">Ø¹Ø§Ø¦Ù„Ø©</div>
    <div class="tab" data-room="public">Ø¹Ø§Ù…Ø©</div>
    <div class="tab" data-room="status">Ø­Ø§Ù„Ø§Øª</div>
  </div>

  <div id="family-chat" class="chat"></div>
  <div id="public-chat" class="chat" style="display:none;"></div>
  <div id="status-section" class="chat" style="display:none;">
    <input type="text" id="statusText" placeholder="Ø§ÙƒØªØ¨ Ø­Ø§Ù„ØªÙƒ..." />
    <button onclick="postStatus()" style="margin:10px auto; display:block; padding:8px 20px;">Ù†Ø´Ø± Ø§Ù„Ø­Ø§Ù„Ø©</button>
    <div id="statusFeed"></div>
  </div>

  <div class="online-list" id="onlineList"></div>

  <div class="input-area" id="main-input">
    <input type="text" id="msg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." onkeypress="if(event.key==='Enter') sendText()" />
    <input type="file" id="imageUpload" accept="image/*,.gif" style="display:none;" />
    <button class="attach-btn" onclick="document.getElementById('imageUpload').click()">ğŸ“</button>
    <button class="emoji-btn" onclick="toggleEmojiPanel()">ğŸ˜Š</button>
    <button onclick="sendText()">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>

  <div id="progressContainer">
    <div id="progressBar"></div>
  </div>

  <div id="emojiPanel"></div>

  <script>
    const emojiList = ['ğŸ˜Š', 'ğŸ˜‚', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤©', 'ğŸ¥³', 'ğŸ˜­', 'ğŸ˜¡', 'ğŸ‘', 'ğŸ‘', 'ğŸ’–', 'ğŸ’¯', 'ğŸ”¥', 'âœ¨', 'ğŸ‰', 'â¤ï¸', 'ğŸ« ', 'ğŸ«¶', 'ğŸ™', 'ğŸš€', 'ğŸŒ™', 'ğŸŒˆ', 'ğŸŒ¸'];
  </script>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let currentRoom = 'family';
    let myName = localStorage.name || prompt('Ù…Ø§ Ø§Ø³Ù…ÙƒØŸ') || 'Ø²Ø§Ø¦Ø±';
    localStorage.name = myName;

    // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    if (Notification.permission !== "granted" && Notification.permission !== "denied") {
      Notification.requestPermission();
    }

    // Ø£ØµÙˆØ§Øª Ø¨Ø¯ÙˆÙ† Ù…Ù„ÙØ§Øª
    function playSendSound() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.type = 'sine';
        osc.frequency.value = 800;
        gain.gain.value = 0.1;
        osc.start();
        setTimeout(() => { osc.stop(); ctx.close(); }, 100);
      } catch (e) {}
    }

    function playReceiveSound() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.type = 'sine';
        osc.frequency.value = 600;
        gain.gain.value = 0.1;
        osc.start();
        setTimeout(() => { osc.stop(); ctx.close(); }, 150);
      } catch (e) {}
    }

    function showNotification(name, text) {
      if (Notification.permission === "granted") {
        new Notification(`Ø¯Ø±Ø¯Ø´Ø© Ù…Ù† ${name}`, {
          body: text,
          icon: "https://cdn-icons-png.flaticon.com/512/3064/3064473.png",
          dir: "rtl"
        });
      }
    }

    function appendMessage(name, text, isSelf, image = null, delivered = false) {
      const chat = document.getElementById(currentRoom === 'family' ? 'family-chat' : 'public-chat');
      const div = document.createElement('div');
      div.className = isSelf ? 'msg out' : 'msg in';
      const statusText = isSelf ? (delivered ? 'âœ“âœ“' : 'âœ“') : '';
      div.innerHTML = `<b>${name}:</b> ${text || ''} ${statusText ? `<span class="delivery-status">${statusText}</span>` : ''}`;
      if (image) {
        const img = document.createElement('img');
        img.src = image;
        img.alt = "ØµÙˆØ±Ø©";
        div.appendChild(document.createElement('br'));
        div.appendChild(img);
      }
      div.style.color = getComputedStyle(document.documentElement).getPropertyValue('--msg-color') || '#333';
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;

      if (!isSelf) {
        playReceiveSound();
        if (document.hidden) {
          showNotification(name, text || 'Ø£Ø±Ø³Ù„ ØµÙˆØ±Ø©');
        }
      }
    }

    function loadMessages(room, msgs) {
      const chat = document.getElementById(room === 'family' ? 'family-chat' : 'public-chat');
      chat.innerHTML = '';
      msgs.forEach(msg => {
        appendMessage(msg.name, msg.text, msg.name === myName, msg.image, true);
      });
    }

    function loadStatuses(statuses) {
      const feed = document.getElementById('statusFeed');
      feed.innerHTML = '';
      statuses.forEach(st => {
        const div = document.createElement('div');
        div.className = 'status-preview';
        div.innerHTML = `<b>${st.name}</b><br>${st.text}`;
        feed.prepend(div);
      });
    }

    function joinRoom(room) {
      socket.emit('joinRoom', { room, name: myName });
    }

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentRoom = tab.dataset.room;

        document.getElementById('family-chat').style.display = currentRoom === 'family' ? 'flex' : 'none';
        document.getElementById('public-chat').style.display = currentRoom === 'public' ? 'flex' : 'none';
        document.getElementById('status-section').style.display = currentRoom === 'status' ? 'block' : 'none';
        document.getElementById('main-input').style.display = currentRoom === 'status' ? 'none' : 'flex';
        document.getElementById('onlineList').style.display = currentRoom === 'status' ? 'none' : 'block';

        if (currentRoom !== 'status') {
          joinRoom(currentRoom);
        } else {
          socket.emit('loadStatuses');
        }
      });
    });

    socket.on('loadMessages', (data) => {
      if (data.room === currentRoom) {
        loadMessages(data.room, data.messages);
      }
    });

    socket.on('allStatuses', (statuses) => {
      loadStatuses(statuses);
    });

    socket.on('onlineUsers', (data) => {
      if (data.room === currentRoom) {
        document.getElementById('onlineCount').textContent = `Ù…ØªØµÙ„ÙŠÙ†: ${data.count}`;
        const listEl = document.getElementById('onlineList');
        listEl.innerHTML = `<b>Ø§Ù„Ù…ØªØµÙ„ÙˆÙ†:</b> ${data.users.join(', ')}`;
        listEl.style.display = 'block';
      }
    });

    function sendText() {
      const text = document.getElementById('msg').value.trim();
      if (!text) return;
      appendMessage(myName, text, true, null, false);
      socket.emit('sendMessage', { room: currentRoom, name: myName, text });
      playSendSound();
      document.getElementById('msg').value = '';
    }

    document.getElementById('imageUpload').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file || !file.type.match('image/')) return;

      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';

      const reader = new FileReader();
      reader.onprogress = (ev) => {
        if (ev.lengthComputable) {
          const percent = Math.round((ev.loaded / ev.total) * 100);
          progressBar.style.width = percent + '%';
        }
      };

      reader.onload = (ev) => {
        appendMessage(myName, '', true, ev.target.result, false);
        socket.emit('sendImage', { room: currentRoom, name: myName, image: ev.target.result });
        playSendSound();
        e.target.value = '';
        progressContainer.style.display = 'none';
      };

      reader.readAsDataURL(file);
    });

    function postStatus() {
      const text = document.getElementById('statusText').value.trim();
      if (!text) return;
      socket.emit('postStatus', { name: myName, text });
      document.getElementById('statusText').value = '';
    }

    socket.on('receiveMessage', (data) => {
      if (data.room === currentRoom) {
        appendMessage(data.name, data.text, data.name === myName, null, true);
      }
    });

    socket.on('receiveImage', (data) => {
      if (data.room === currentRoom) {
        appendMessage(data.name, '', data.name === myName, data.image, true);
      }
    });

    socket.on('newStatus', (data) => {
      const feed = document.getElementById('statusFeed');
      const div = document.createElement('div');
      div.className = 'status-preview';
      div.innerHTML = `<b>${data.name}</b><br>${data.text}`;
      feed.prepend(div);
    });

    // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ø®Ø· ÙƒÙ„ 10 Ø«ÙˆØ§Ù†Ù
    const colors = ['#333', '#075e54', '#d32f2f', '#1976d2', '#689f38', '#f57c00', '#7b1fa2', '#00796b'];
    let colorIndex = 0;
    setInterval(() => {
      const newColor = colors[colorIndex % colors.length];
      colorIndex++;
      document.querySelectorAll('.msg').forEach(el => {
        el.style.color = newColor;
      });
    }, 10000);

    function toggleEmojiPanel() {
      const panel = document.getElementById('emojiPanel');
      if (panel.style.display === 'flex') {
        panel.style.display = 'none';
      } else {
        panel.innerHTML = '';
        emojiList.forEach(emoji => {
          const span = document.createElement('span');
          span.className = 'emoji-item';
          span.textContent = emoji;
          span.onclick = () => {
            document.getElementById('msg').value += emoji;
            document.getElementById('msg').focus();
            panel.style.display = 'none';
          };
          panel.appendChild(span);
        });
        panel.style.display = 'flex';
      }
    }

    document.addEventListener('click', (e) => {
      const panel = document.getElementById('emojiPanel');
      const btn = document.querySelector('.emoji-btn');
      if (!panel.contains(e.target) && e.target !== btn) {
        panel.style.display = 'none';
      }
    });

    joinRoom(currentRoom);
  </script>
</body>
</html>
