<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>Ø¯Ø±Ø¯Ø´ØªÙŠ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma; background: #000; color: white; height: 100vh; display: flex; flex-direction: column; }
    .header { background: #075e54; padding: 8px 10px; font-size: 16px; display: flex; justify-content: space-between; align-items: center; }
    .tabs { display: flex; background: #075e54; }
    .tab { flex: 1; padding: 10px 0; text-align: center; font-size: 14px; cursor: pointer; color: #ddd; }
    .tab.active { color: white; border-bottom: 2px solid #25D366; }
    .section { position: relative; flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
    .stars { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; }
    .star { position: absolute; background: white; border-radius: 50%; animation: twinkle 3s infinite; }
    @keyframes twinkle { 0%,100% { opacity: 0.2; } 50% { opacity: 1; } }
    .msg { max-width: 75%; padding: 10px; border-radius: 15px; background: #0d3b66; font-size: 14px; }
    .in { align-self: flex-start; }
    .out { align-self: flex-end; }
    .input-area { display: flex; padding: 8px; background: rgba(255,255,255,0.08); gap: 6px; align-items: center; flex-wrap: wrap; }
    .input-area input { flex: 1; padding: 8px 12px; border: none; background: rgba(0,0,0,0.3); border-radius: 20px; font-size: 14px; color: white; min-width: 150px; }
    .input-area button { padding: 8px 16px; background: #075e54; color: white; border: none; border-radius: 18px; font-size: 14px; cursor: pointer; }
    .action-btn { width: 36px; height: 36px; border-radius: 50%; background: #5c677d; color: white; border: none; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .online-indicator { font-size: 13px; background: #25D366; padding: 3px 8px; border-radius: 12px; }
    .post { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 12px; margin-bottom: 12px; }
    .post-form { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 12px; margin: 12px 0; }
    .post-form textarea { width: 100%; padding: 8px; border: none; background: rgba(0,0,0,0.3); border-radius: 8px; color: white; resize: none; height: 60px; font-size: 14px; }
    .post-actions { margin-top: 8px; display: flex; gap: 12px; font-size: 13px; color: #a0aec0; cursor: pointer; }
    .voice-btn.recording { background: #d32f2f; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(211,47,47,0.5); } 70% { box-shadow: 0 0 0 8px rgba(211,47,47,0); } 100% { box-shadow: 0 0 0 0 rgba(211,47,47,0); } }
  </style>
</head>
<body>
  <div class="header">
    <span>Ø¯Ø±Ø¯Ø´ØªÙŠ</span>
    <div class="online-indicator" id="onlineCount">Ù…ØªØµÙ„ÙŠÙ†: 0</div>
  </div>
  
  <div class="tabs">
    <div class="tab active" data-room="family">Ø¹Ø§Ø¦Ù„Ø©</div>
    <div class="tab" data-room="public">Ø¹Ø§Ù…Ø©</div>
    <div class="tab" data-room="posts">Ù…Ù†Ø´ÙˆØ±Ø§Øª</div>
  </div>

  <div id="family-chat" class="section">
    <div class="stars" id="stars-family"></div>
  </div>
  <div id="public-chat" class="section" style="display:none;">
    <div class="stars" id="stars-public"></div>
  </div>
  <div id="posts-section" class="section" style="display:none;">
    <div class="stars" id="stars-posts"></div>
    <div class="post-form">
      <textarea id="postText" placeholder="Ø§ÙƒØªØ¨ Ù…Ù†Ø´ÙˆØ±Ùƒ..."></textarea>
      <button onclick="publishPost()">Ù†Ø´Ø±</button>
    </div>
    <div id="postsFeed"></div>
  </div>

  <div class="input-area" id="main-input">
    <input type="text" id="msg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." />
    <button class="action-btn" onclick="document.getElementById('audioUpload').click()">ğŸ¤</button>
    <input type="file" id="audioUpload" accept="audio/*" style="display:none;" />
    <button onclick="sendText()">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let currentRoom = 'family';
    let myName = localStorage.name || prompt('Ù…Ø§ Ø§Ø³Ù…ÙƒØŸ') || 'Ø²Ø§Ø¦Ø±';
    localStorage.name = myName;

    // --- Ø§Ù„Ø£ØµÙˆØ§Øª ---
    function playSound(type) {
      const audio = new Audio(`/sounds/${type}.mp3`);
      audio.play().catch(e => console.log(`ÙØ´Ù„ ØµÙˆØª ${type}:`, e));
    }

    // --- Ø§Ù„Ù†Ø¬ÙˆÙ… ---
    function createStars(containerId) {
      const container = document.getElementById(containerId);
      if (!container) return;
      container.innerHTML = '';
      for (let i = 0; i < 50; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.width = Math.random() * 2 + 1 + 'px';
        star.style.height = star.style.width;
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.animationDuration = Math.random() * 3 + 2 + 's';
        container.appendChild(star);
      }
    }

    // --- Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ---
    function appendMessage(name, text, isSelf, audio = null) {
      const chat = document.getElementById(currentRoom === 'family' ? 'family-chat' : 'public-chat');
      if (!chat) return;
      
      const div = document.createElement('div');
      div.className = isSelf ? 'msg out' : 'msg in';
      
      if (audio) {
        div.innerHTML = `<b>${name}:</b><br><audio controls src="${audio}"></audio>`;
      } else {
        div.innerHTML = `<b>${name}:</b> ${text}`;
      }
      
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
      
      if (!isSelf) playSound('receive');
    }

    function sendText() {
      const text = document.getElementById('msg').value.trim();
      if (!text) return;
      socket.emit('sendMessage', { room: currentRoom, name: myName, text });
      playSound('send');
      document.getElementById('msg').value = '';
    }

    // --- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª ---
    document.getElementById('audioUpload').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (ev) => {
        socket.emit('sendAudio', { room: currentRoom, name: myName, audio: ev.target.result });
        playSound('send');
      };
      reader.readAsDataURL(file);
    });

    // --- Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª ---
    let posts = [];

    function renderPosts() {
      const feed = document.getElementById('postsFeed');
      if (!feed) return;
      feed.innerHTML = '';
      posts.forEach(post => {
        const div = document.createElement('div');
        div.className = 'post';
        div.innerHTML = `
          <div><b>${post.name}:</b> ${post.text}</div>
          <div class="post-actions">
            <span onclick="likePost(${post.id})">ğŸ‘ ${post.likes || 0}</span>
            <span>ğŸ’¬ ${post.comments?.length || 0}</span>
          </div>
        `;
        feed.appendChild(div);
      });
    }

    function publishPost() {
      const text = document.getElementById('postText').value.trim();
      if (!text) return;
      socket.emit('publishPost', { name: myName, text });
      playSound('send');
      document.getElementById('postText').value = '';
    }

    function likePost(postId) {
      socket.emit('likePost', postId);
      playSound('like');
    }

    // --- Ø§Ù„Ø§ØªØµØ§Ù„ ---
    socket.on('connect', () => {
      joinRoom(currentRoom);
    });

    function joinRoom(room) {
      currentRoom = room;
      socket.emit('joinRoom', { room, name: myName });
    }

    socket.on('loadMessages', (data) => {
      if (data.room === currentRoom) {
        const chat = document.getElementById(currentRoom === 'family' ? 'family-chat' : 'public-chat');
        if (chat) chat.innerHTML = '';
        data.messages.forEach(msg => {
          if (msg.type === 'audio') {
            appendMessage(msg.name, null, msg.name === myName, msg.audio);
          } else {
            appendMessage(msg.name, msg.text, msg.name === myName);
          }
        });
      }
    });

    socket.on('onlineUsers', (data) => {
      if (data.room === currentRoom) {
        document.getElementById('onlineCount').innerText = `Ù…ØªØµÙ„ÙŠÙ†: ${data.count}`;
      }
    });

    socket.on('receiveMessage', (data) => {
      if (data.room === currentRoom) {
        appendMessage(data.name, data.text, data.name === myName);
      }
    });

    socket.on('receiveAudio', (data) => {
      if (data.room === currentRoom) {
        appendMessage(data.name, null, data.name === myName, data.audio);
      }
    });

    socket.on('allPosts', (allPosts) => {
      posts = allPosts;
      renderPosts();
    });

    socket.on('newPost', (post) => {
      posts.push(post);
      renderPosts();
    });

    socket.on('updatePost', (updatedPost) => {
      const index = posts.findIndex(p => p.id === updatedPost.id);
      if (index !== -1) {
        posts[index] = updatedPost;
        renderPosts();
      }
    });

    // --- Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ---
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentRoom = tab.dataset.room;
        
        document.getElementById('family-chat').style.display = currentRoom === 'family' ? 'flex' : 'none';
        document.getElementById('public-chat').style.display = currentRoom === 'public' ? 'flex' : 'none';
        document.getElementById('posts-section').style.display = currentRoom === 'posts' ? 'flex' : 'none';
        document.getElementById('main-input').style.display = currentRoom === 'posts' ? 'none' : 'flex';
        
        if (currentRoom !== 'posts') {
          joinRoom(currentRoom);
        }
      });
    });

    // --- Ø¨Ø¯Ø¡ ---
    createStars('stars-family');
    createStars('stars-public');
    createStars('stars-posts');

    if (socket.connected) {
      joinRoom(currentRoom);
    }
  </script>
</body>
</html>
