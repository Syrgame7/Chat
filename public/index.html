<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>3D Chat World</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
        #chat-container {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 300px;
            pointer-events: none; /* للسماح بالنقر على الـ 3D */
        }
        #messages {
            list-style: none; margin: 0; padding: 10px;
            background: rgba(0,0,0,0.5); color: white;
            height: 200px; overflow-y: auto; border-radius: 8px;
            pointer-events: auto;
        }
        #form { display: flex; margin-top: 5px; pointer-events: auto; }
        #input { flex: 1; padding: 10px; border-radius: 5px; border: none; }
        #btn { padding: 10px; cursor: pointer; }
        
        /* فقاعة الدردشة فوق اللاعبين */
        .chat-bubble {
            position: absolute;
            background: white;
            padding: 5px 10px;
            border-radius: 10px;
            display: none;
            font-size: 12px;
            pointer-events: none;
            transform: translate(-50%, -100%);
        }
    </style>
</head>
<body>

    <!-- واجهة الدردشة -->
    <div id="chat-container">
        <ul id="messages"></ul>
        <form id="form" action="">
            <input id="input" autocomplete="off" placeholder="اكتب رسالة..." /><button id="btn">إرسال</button>
        </form>
    </div>

    <!-- مكتبات خارجية -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script>
        // 1. إعدادات Three.js الأساسية
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB); // لون السماء
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // إضاءة
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(10, 20, 10);
        scene.add(dirLight);

        // الأرضية
        const floorGeometry = new THREE.PlaneGeometry(100, 100);
        const floorMaterial = new THREE.MeshStandardMaterial({ color: 0x228B22 });
        const floor = new THREE.Mesh(floorGeometry, floorMaterial);
        floor.rotation.x = -Math.PI / 2;
        scene.add(floor);

        // 2. منطق اللعبة والاتصال
        const socket = io();
        const playersMeshes = {}; // لتخزين مجسمات اللاعبين
        const mySpeed = 0.2;
        let myId = null;

        // دالة إنشاء لاعب
        function createPlayerMesh(playerInfo, id) {
            const geometry = new THREE.BoxGeometry(1, 1, 1);
            const material = new THREE.MeshStandardMaterial({ color: playerInfo.color });
            const cube = new THREE.Mesh(geometry, material);
            cube.position.set(playerInfo.x, playerInfo.y, playerInfo.z);
            
            scene.add(cube);
            playersMeshes[id] = cube;

            // إنشاء عنصر HTML لفقاعة الدردشة لهذا اللاعب
            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble';
            bubble.id = `bubble-${id}`;
            document.body.appendChild(bubble);
        }

        socket.on('connect', () => {
            myId = socket.id;
        });

        // تحميل اللاعبين الحاليين
        socket.on('currentPlayers', (players) => {
            Object.keys(players).forEach((id) => {
                if (id !== socket.id) createPlayerMesh(players[id], id);
            });
            // إنشاء لاعبي أنا
            if(players[socket.id]) createPlayerMesh(players[socket.id], socket.id);
        });

        // انضمام لاعب جديد
        socket.on('newPlayer', (data) => {
            createPlayerMesh(data.player, data.id);
            playSound('join');
        });

        // حركة لاعب آخر
        socket.on('playerMoved', (data) => {
            if (playersMeshes[data.id]) {
                playersMeshes[data.id].position.set(data.x, data.y, data.z);
                updateBubblePosition(data.id);
            }
        });

        // خروج لاعب
        socket.on('userDisconnect', (id) => {
            if (playersMeshes[id]) {
                scene.remove(playersMeshes[id]);
                delete playersMeshes[id];
                const bubble = document.getElementById(`bubble-${id}`);
                if(bubble) bubble.remove();
            }
        });

        // 3. نظام الدردشة
        const form = document.getElementById('form');
        const input = document.getElementById('input');
        const messages = document.getElementById('messages');

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (input.value) {
                socket.emit('chatMessage', input.value);
                input.value = '';
            }
        });

        socket.on('chatMessage', (data) => {
            // إضافة للقائمة
            const item = document.createElement('li');
            item.textContent = (data.id === myId ? 'أنت' : 'لاعب') + ": " + data.msg;
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
            
            // إظهار فقاعة فوق اللاعب
            showBubble(data.id, data.msg);
            
            // تشغيل صوت
            playSound('msg');
        });

        // دالة إظهار الفقاعة
        function showBubble(id, text) {
            const bubble = document.getElementById(`bubble-${id}`);
            if (bubble) {
                bubble.textContent = text;
                bubble.style.display = 'block';
                // إخفاء بعد 3 ثواني
                setTimeout(() => { bubble.style.display = 'none'; }, 3000);
            }
        }

        // دالة تحديث مكان الفقاعة لتتبع اللاعب في الـ 3D
        function updateBubblePosition(id) {
            const bubble = document.getElementById(`bubble-${id}`);
            const mesh = playersMeshes[id];
            if (bubble && mesh) {
                const vector = mesh.position.clone();
                vector.y += 1.5; // فوق الرأس
                vector.project(camera);
                
                const x = (vector.x * .5 + .5) * window.innerWidth;
                const y = -(vector.y * .5 - .5) * window.innerHeight;

                bubble.style.left = `${x}px`;
                bubble.style.top = `${y}px`;
            }
        }

        // 4. التحكم والحركة
        const keys = {};
        document.addEventListener('keydown', (e) => keys[e.code] = true);
        document.addEventListener('keyup', (e) => keys[e.code] = false);

        function animate() {
            requestAnimationFrame(animate);

            if (myId && playersMeshes[myId]) {
                const myMesh = playersMeshes[myId];
                let moved = false;

                if (keys['ArrowUp'] || keys['KeyW']) { myMesh.position.z -= mySpeed; moved = true; }
                if (keys['ArrowDown'] || keys['KeyS']) { myMesh.position.z += mySpeed; moved = true; }
                if (keys['ArrowLeft'] || keys['KeyA']) { myMesh.position.x -= mySpeed; moved = true; }
                if (keys['ArrowRight'] || keys['KeyD']) { myMesh.position.x += mySpeed; moved = true; }

                if (moved) {
                    camera.position.set(myMesh.position.x, myMesh.position.y + 5, myMesh.position.z + 10);
                    camera.lookAt(myMesh.position);
                    socket.emit('playerMovement', { x: myMesh.position.x, y: myMesh.position.y, z: myMesh.position.z });
                    updateBubblePosition(myId);
                } else {
                    // تحديث الكاميرا حتى لو لم نتحرك (في البداية)
                    camera.position.set(myMesh.position.x, myMesh.position.y + 5, myMesh.position.z + 10);
                    camera.lookAt(myMesh.position);
                }
            }

            // تحديث مكان فقاعات اللاعبين الآخرين
            Object.keys(playersMeshes).forEach(id => {
                if (id !== myId) updateBubblePosition(id);
            });

            renderer.render(scene, camera);
        }
        animate();

        // 5. نظام صوت بسيط (Beep synthesizer)
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if (type === 'msg') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(500, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
            } else { // join
                oscillator.type = 'triangle';
                oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
            }
            
            oscillator.start();
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.5);
            oscillator.stop(audioCtx.currentTime + 0.5);
        }
        
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
