<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <meta name="referrer" content="no-referrer">
  <title>Ø¯Ø±Ø¯Ø´ØªÙŠ</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Tajawal', Arial, sans-serif;
      background: #0d0d1a;
      height: 100vh;
      display: flex;
      flex-direction: column;
      color: #fff;
      overscroll-behavior: none;
    }
    .header {
      background: rgba(7, 94, 84, 0.95);
      color: white;
      padding: 12px 16px;
      text-align: center;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    .tabs {
      display: flex;
      background: #075e54;
      padding: 0;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }
    .tab {
      flex: 1;
      padding: 14px 0;
      text-align: center;
      cursor: pointer;
      color: rgba(255,255,255,0.8);
      transition: color 0.2s;
      font-weight: 500;
    }
    .tab:hover { color: white; }
    .tab.active {
      color: white;
      font-weight: 700;
      border-bottom: 2px solid #25D366;
    }
    .chat {
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .msg {
      max-width: 75%;
      padding: 12px;
      border-radius: 18px;
      word-wrap: break-word;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
      transition: background-color 0.5s ease;
    }
    .in { background: var(--msg-in-bg, #2c2c3e); align-self: flex-start; border-bottom-left-radius: 6px; }
    .out { background: var(--msg-out-bg, #1e3a5f); align-self: flex-end; border-bottom-right-radius: 6px; }
    
    .msg-content {
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }
    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #25D366;
    }
    .msg-text {
      flex: 1;
      direction: rtl;
    }
    .msg-text b {
      display: block;
      font-weight: 600;
      margin-bottom: 4px;
      color: #fff;
    }
    .msg-text img, .msg-text audio {
      max-width: 100%;
      border-radius: 10px;
      margin-top: 6px;
      display: block;
    }

    .input-area {
      display: flex;
      padding: 12px;
      background: rgba(255,255,255,0.08);
      gap: 8px;
      border-top: 1px solid rgba(255,255,255,0.1);
      align-items: center;
      flex-wrap: wrap;
    }
    .input-area input {
      flex: 1;
      padding: 12px 18px;
      border: none;
      background: rgba(0,0,0,0.3);
      border-radius: 24px;
      font-size: 15px;
      outline: none;
      min-width: 200px;
      color: white;
    }
    .input-area button {
      border: none;
      background: #075e54;
      color: white;
      padding: 0 18px;
      border-radius: 20px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    .attach-btn, .emoji-btn, .voice-btn {
      background: #5c677d;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      transition: background 0.2s;
    }
    .voice-btn.recording {
      background: #d32f2f;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.5); }
      70% { box-shadow: 0 0 0 12px rgba(211, 47, 47, 0); }
      100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); }
    }

    .status-preview {
      max-width: 80%;
      margin: 12px auto;
      padding: 14px;
      background: rgba(255,255,255,0.1);
      border-radius: 14px;
      text-align: center;
      backdrop-filter: blur(5px);
    }
    #statusText {
      width: 90%;
      margin: 12px auto;
      padding: 12px;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      background: rgba(0,0,0,0.3);
      color: white;
      font-family: 'Tajawal', sans-serif;
      font-size: 15px;
    }
    #progressContainer {
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      margin: 8px 0;
      overflow: hidden;
      display: none;
    }
    #progressBar {
      height: 100%;
      background: #25D366;
      width: 0%;
      transition: width 0.2s;
    }
    #emojiPanel {
      display: none;
      position: absolute;
      bottom: 90px;
      right: 20px;
      background: rgba(30, 30, 46, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
      z-index: 100;
      max-width: 320px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .emoji-item {
      font-size: 22px;
      cursor: pointer;
      padding: 6px;
      border-radius: 8px;
      transition: transform 0.2s;
    }
    .emoji-item:hover {
      transform: scale(1.2);
      background: rgba(255,255,255,0.1);
    }
    .online-indicator {
      font-size: 13px;
      color: #fff;
      background: #25D366;
      padding: 4px 12px;
      border-radius: 20px;
      margin-left: 10px;
    }
    .online-list {
      font-size: 12px;
      color: #e0e0ff;
      background: rgba(255,255,255,0.08);
      padding: 8px 12px;
      border-radius: 10px;
      margin: 10px 16px 0;
      display: none;
      backdrop-filter: blur(5px);
    }
    .delivery-status {
      font-size: 12px;
      color: #aaa;
      margin-top: 4px;
      direction: ltr;
    }

    #inAppNotification {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: rgba(7, 94, 84, 0.95);
      color: white;
      padding: 14px 18px;
      border-radius: 14px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
      z-index: 1000;
      max-width: 280px;
      display: none;
      font-family: 'Tajawal', sans-serif;
      direction: rtl;
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateY(100px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .default-avatar {
      background: #4a5568;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #cbd5e0;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="header">
    <div style="display:flex;align-items:center;gap:12px;">
      <div id="userAvatarContainer" style="width:36px;height:36px;border-radius:50%;overflow:hidden;cursor:pointer;" onclick="changeAvatar()">
        <img id="userAvatar" src="" alt="Ø£Ù†Ø§" style="width:100%;height:100%;object-fit:cover;" />
      </div>
      <span>Ø¯Ø±Ø¯Ø´ØªÙŠ</span>
    </div>
    <div class="online-indicator" id="onlineCount">Ù…ØªØµÙ„ÙŠÙ†: 0</div>
  </div>
  
  <div class="tabs">
    <div class="tab active" data-room="family">Ø¹Ø§Ø¦Ù„Ø©</div>
    <div class="tab" data-room="public">Ø¹Ø§Ù…Ø©</div>
    <div class="tab" data-room="status">Ø­Ø§Ù„Ø§Øª</div>
  </div>

  <div id="family-chat" class="chat"></div>
  <div id="public-chat" class="chat" style="display:none;"></div>
  <div id="status-section" class="chat" style="display:none;">
    <input type="text" id="statusText" placeholder="Ø§ÙƒØªØ¨ Ø­Ø§Ù„ØªÙƒ..." />
    <button onclick="postStatus()" style="margin:10px auto; display:block; padding:8px 20px; background:#075e54; color:white; border:none; border-radius:8px;">Ù†Ø´Ø± Ø§Ù„Ø­Ø§Ù„Ø©</button>
    <div id="statusFeed"></div>
  </div>

  <div class="online-list" id="onlineList"></div>

  <div class="input-area" id="main-input">
    <input type="text" id="msg" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." onkeypress="if(event.key==='Enter') sendText()" />
    <input type="file" id="imageUpload" accept="image/*" style="display:none;" />
    <button class="attach-btn" onclick="document.getElementById('imageUpload').click()">ğŸ“</button>
    <button class="emoji-btn" onclick="toggleEmojiPanel()">ğŸ˜Š</button>
    <button class="voice-btn" onclick="recordAudio()">ğŸ¤</button>
    <button onclick="sendText()">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>

  <div id="progressContainer">
    <div id="progressBar"></div>
  </div>

  <div id="emojiPanel"></div>

  <div id="inAppNotification">
    <b id="notifName"></b><br>
    <span id="notifText"></span>
  </div>

  <script>
    const emojiList = ['ğŸ˜Š', 'ğŸ˜‚', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤©', 'ğŸ¥³', 'ğŸ˜­', 'ğŸ˜¡', 'ğŸ‘', 'ğŸ‘', 'ğŸ’–', 'ğŸ’¯', 'ğŸ”¥', 'âœ¨', 'ğŸ‰', 'â¤ï¸', 'ğŸ« ', 'ğŸ«¶', 'ğŸ™', 'ğŸš€', 'ğŸŒ™', 'ğŸŒˆ', 'ğŸŒ¸'];
  </script>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let currentRoom = 'family';
    let myName = localStorage.name || prompt('Ù…Ø§ Ø§Ø³Ù…ÙƒØŸ') || 'Ø²Ø§Ø¦Ø±';
    localStorage.name = myName;

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©
    let myAvatar = localStorage.getItem('userAvatar') || null;
    if (!myAvatar) {
      // ØµÙˆØ±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
      myAvatar = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24"><circle cx="12" cy="8" r="5" fill="%23cbd5e0"/><path d="M20 22H4a1 1 0 01-1-1v-2a5 5 0 015-5h8a5 5 0 015 5v2a1 1 0 01-1 1z" fill="%23a0aec0"/></svg>';
      localStorage.setItem('userAvatar', myAvatar);
    }
    document.getElementById('userAvatar').src = myAvatar;

    // Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª
    let audioContext = null;
    let soundsEnabled = false;

    function initAudio() {
      if (soundsEnabled) return;
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        soundsEnabled = true;
      } catch (e) {}
    }

    function playTone(freq, duration = 100, volume = 0.1) {
      if (!soundsEnabled) return;
      try {
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc.connect(gain);
        gain.connect(audioContext.destination);
        osc.type = 'sine';
        osc.frequency.value = freq;
        gain.gain.value = volume;
        osc.start();
        setTimeout(() => { osc.stop(); }, duration);
      } catch (e) {}
    }

    function playSendSound() { playTone(800, 100); }
    function playReceiveSound() { playTone(600, 150); }

    document.body.addEventListener('click', initAudio, { once: true });
    document.body.addEventListener('touchstart', initAudio, { once: true });

    // Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©
    const unreadCounts = { family: 0, public: 0 };

    function showInAppNotification(name, text, room) {
      if (currentRoom !== room) {
        unreadCounts[room]++;

        const tab = document.querySelector(`.tab[data-room="${room}"]`);
        const baseName = room === 'family' ? 'Ø¹Ø§Ø¦Ù„Ø©' : 'Ø¹Ø§Ù…Ø©';
        tab.textContent = `${baseName} (${unreadCounts[room]})`;

        const notif = document.getElementById('inAppNotification');
        document.getElementById('notifName').textContent = name;
        document.getElementById('notifText').textContent = text || 'Ø£Ø±Ø³Ù„ Ù…Ø­ØªÙˆÙ‰';
        notif.style.display = 'block';

        setTimeout(() => {
          notif.style.display = 'none';
        }, 4000);
      }
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    function appendMessage(name, text, isSelf, image = null, audio = null, senderAvatar = null) {
      const chat = document.getElementById(currentRoom === 'family' ? 'family-chat' : 'public-chat');
      const div = document.createElement('div');
      div.className = isSelf ? 'msg out' : 'msg in';

      const avatarSrc = senderAvatar || 
        'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24"><circle cx="12" cy="8" r="5" fill="%23cbd5e0"/><path d="M20 22H4a1 1 0 01-1-1v-2a5 5 0 015-5h8a5 5 0 015 5v2a1 1 0 01-1 1z" fill="%23a0aec0"/></svg>';

      let mediaHtml = '';
      if (image) {
        mediaHtml = `<img src="${image}" />`;
      } else if (audio) {
        mediaHtml = `<audio controls src="${audio}"></audio>`;
      }

      const statusText = isSelf ? 'âœ“âœ“' : '';

      div.innerHTML = `
        <div class="msg-content">
          <img src="${avatarSrc}" class="avatar" />
          <div class="msg-text">
            <b>${name}</b>
            ${text || ''}
            ${mediaHtml}
            ${statusText ? `<div class="delivery-status">${statusText}</div>` : ''}
          </div>
        </div>
      `;

      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;

      if (!isSelf) {
        playReceiveSound();
      }
    }

    function loadMessages(room, msgs) {
      const chat = document.getElementById(room === 'family' ? 'family-chat' : 'public-chat');
      chat.innerHTML = '';
      msgs.forEach(msg => {
        if (msg.type === 'text') {
          appendMessage(msg.name, msg.text, msg.name === myName, null, null, msg.avatar);
        } else if (msg.type === 'image') {
          appendMessage(msg.name, '', msg.name === myName, msg.image, null, msg.avatar);
        } else if (msg.type === 'audio') {
          appendMessage(msg.name, '', msg.name === myName, null, msg.audio, msg.avatar);
        }
      });
    }

    function loadStatuses(statuses) {
      const feed = document.getElementById('statusFeed');
      feed.innerHTML = '';
      statuses.forEach(st => {
        const div = document.createElement('div');
        div.className = 'status-preview';
        div.innerHTML = `<b>${st.name}</b><br>${st.text}`;
        feed.prepend(div);
      });
    }

    function joinRoom(room) {
      socket.emit('joinRoom', { room, name: myName, avatar: myAvatar });
    }

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentRoom = tab.dataset.room;

        document.getElementById('family-chat').style.display = currentRoom === 'family' ? 'flex' : 'none';
        document.getElementById('public-chat').style.display = currentRoom === 'public' ? 'flex' : 'none';
        document.getElementById('status-section').style.display = currentRoom === 'status' ? 'block' : 'none';
        document.getElementById('main-input').style.display = currentRoom === 'status' ? 'none' : 'flex';
        document.getElementById('onlineList').style.display = currentRoom === 'status' ? 'none' : 'block';

        if (currentRoom !== 'status') {
          unreadCounts[currentRoom] = 0;
          const baseName = currentRoom === 'family' ? 'Ø¹Ø§Ø¦Ù„Ø©' : 'Ø¹Ø§Ù…Ø©';
          tab.textContent = baseName;
          joinRoom(currentRoom);
        } else {
          socket.emit('loadStatuses', []);
        }
      });
    });

    socket.on('loadMessages', (data) => {
      if (data.room === currentRoom) loadMessages(data.room, data.messages);
    });

    socket.on('loadStatuses', (statuses) => loadStatuses(statuses));

    socket.on('onlineUsers', (data) => {
      if (data.room === currentRoom) {
        document.getElementById('onlineCount').textContent = `Ù…ØªØµÙ„ÙŠÙ†: ${data.count}`;
        const listEl = document.getElementById('onlineList');
        listEl.innerHTML = `<b>Ø§Ù„Ù…ØªØµÙ„ÙˆÙ†:</b> ${data.users.join(', ')}`;
        listEl.style.display = 'block';
      }
    });

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© Ù„Ù„Ø¢Ø®Ø±ÙŠÙ†
    socket.on('userAvatarUpdate', (data) => {
      // Ù†Ø®Ø²Ù†Ù‡Ø§ ÙÙŠ localStorage Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      localStorage.setItem(`avatar_${data.name}`, data.avatar);
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      document.querySelectorAll(`.msg-text b`).forEach(el => {
        if (el.textContent.trim() === data.name + ':') {
          const avatarImg = el.closest('.msg-content').querySelector('.avatar');
          if (avatarImg) avatarImg.src = data.avatar;
        }
      });
    });

    function sendText() {
      const text = document.getElementById('msg').value.trim();
      if (!text) return;
      socket.emit('sendMessage', { room: currentRoom, name: myName, text });
      playSendSound();
      document.getElementById('msg').value = '';
    }

    document.getElementById('imageUpload').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file || !file.type.match('image/')) return;

      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';

      const reader = new FileReader();
      reader.onprogress = (ev) => {
        if (ev.lengthComputable) {
          const percent = Math.round((ev.loaded / ev.total) * 100);
          progressBar.style.width = percent + '%';
        }
      };

      reader.onload = (ev) => {
        socket.emit('sendImage', { room: currentRoom, name: myName, image: ev.target.result });
        playSendSound();
        e.target.value = '';
        progressContainer.style.display = 'none';
      };

      reader.readAsDataURL(file);
    });

    async function recordAudio() {
      const voiceBtn = document.querySelector('.voice-btn');
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        voiceBtn.classList.add('recording');
        voiceBtn.innerHTML = 'ğŸ™ï¸';

        const mediaRecorder = new MediaRecorder(stream);
        const chunks = [];

        mediaRecorder.ondataavailable = (e) => {
          chunks.push(e.data);
        };

        mediaRecorder.onstop = async () => {
          voiceBtn.classList.remove('recording');
          voiceBtn.innerHTML = 'ğŸ¤';
          stream.getTracks().forEach(track => track.stop());

          const blob = new Blob(chunks, { type: 'audio/ogg; codecs=opus' });
          const reader = new FileReader();
          reader.onload = () => {
            socket.emit('sendAudio', { room: currentRoom, name: myName, audio: reader.result });
            playSendSound();
          };
          reader.readAsDataURL(blob);
        };

        mediaRecorder.start();
        setTimeout(() => { mediaRecorder.stop(); }, 8000);

      } catch (err) {
        voiceBtn.classList.remove('recording');
        voiceBtn.innerHTML = 'ğŸ¤';
        alert('Ù„Ù… ÙŠØªÙ…ÙƒÙ† Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†: ' + (err.message || 'Ø§Ù„Ø¥Ø°Ù† Ù…Ø±ÙÙˆØ¶'));
      }
    }

    function postStatus() {
      const text = document.getElementById('statusText').value.trim();
      if (!text) return;
      socket.emit('postStatus', { name: myName, text });
      document.getElementById('statusText').value = '';
    }

    socket.on('receiveMessage', (data) => {
      const isSelf = data.name === myName;
      if (data.room === currentRoom) {
        appendMessage(data.name, data.text, isSelf, null, null, data.avatar);
      } else {
        showInAppNotification(data.name, data.text, data.room);
      }
    });

    socket.on('receiveImage', (data) => {
      const isSelf = data.name === myName;
      if (data.room === currentRoom) {
        appendMessage(data.name, '', isSelf, data.image, null, data.avatar);
      } else {
        showInAppNotification(data.name, 'Ø£Ø±Ø³Ù„ ØµÙˆØ±Ø©', data.room);
      }
    });

    socket.on('receiveAudio', (data) => {
      const isSelf = data.name === myName;
      if (data.room === currentRoom) {
        appendMessage(data.name, '', isSelf, null, data.audio, data.avatar);
      } else {
        showInAppNotification(data.name, 'Ø£Ø±Ø³Ù„ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©', data.room);
      }
    });

    socket.on('newStatus', (data) => {
      const feed = document.getElementById('statusFeed');
      const div = document.createElement('div');
      div.className = 'status-preview';
      div.innerHTML = `<b>${data.name}</b><br>${data.text}`;
      feed.prepend(div);
    });

    // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„ÙÙ‚Ø§Ø¹Ø§Øª ÙƒÙ„ 15 Ø«Ø§Ù†ÙŠØ©
    const bubbleColors = [
      { in: '#2c2c3e', out: '#1e3a5f' },
      { in: '#2d3748', out: '#2b6cb0' },
      { in: '#2f2f47', out: '#4c51bf' },
      { in: '#2c3a47', out: '#38ada9' },
      { in: '#2f3542', out: '#ff6b81' },
      { in: '#2c2e3e', out: '#55efc4' },
      { in: '#2d3436', out: '#fdcb6e' },
      { in: '#2f3640', out: '#a29bfe' }
    ];

    let colorIndex = 0;
    setInterval(() => {
      const colors = bubbleColors[colorIndex % bubbleColors.length];
      colorIndex++;
      document.documentElement.style.setProperty('--msg-in-bg', colors.in);
      document.documentElement.style.setProperty('--msg-out-bg', colors.out);
      
      document.querySelectorAll('.msg.in').forEach(el => el.style.backgroundColor = colors.in);
      document.querySelectorAll('.msg.out').forEach(el => el.style.backgroundColor = colors.out);
    }, 15000);

    // Ù„ÙˆØ­Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
    function toggleEmojiPanel() {
      const panel = document.getElementById('emojiPanel');
      if (panel.style.display === 'flex') {
        panel.style.display = 'none';
      } else {
        panel.innerHTML = '';
        emojiList.forEach(emoji => {
          const span = document.createElement('span');
          span.className = 'emoji-item';
          span.textContent = emoji;
          span.onclick = () => {
            document.getElementById('msg').value += emoji;
            document.getElementById('msg').focus();
            panel.style.display = 'none';
          };
          panel.appendChild(span);
        });
        panel.style.display = 'flex';
      }
    }

    document.addEventListener('click', (e) => {
      const panel = document.getElementById('emojiPanel');
      const btn = document.querySelector('.emoji-btn');
      if (!panel.contains(e.target) && e.target !== btn) {
        panel.style.display = 'none';
      }
    });

    // ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©
    function changeAvatar() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          myAvatar = ev.target.result;
          localStorage.setItem('userAvatar', myAvatar);
          document.getElementById('userAvatar').src = myAvatar;
          // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø®Ø§Ø¯Ù…
          socket.emit('updateAvatar', { avatar: myAvatar });
        };
        reader.readAsDataURL(file);
      };
      input.click();
    }

    joinRoom(currentRoom);
  </script>
</body>
    </html>
